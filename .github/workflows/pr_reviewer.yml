name: Automated PR Review Agent

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze:
    name: Analyze PR
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install analysis tool(s)
        run: pip install semgrep
      - name: Run static analysis
        run: |
          semgrep --config auto  --json --output result.json || true
      - name: Save results
        uses: actions/upload-artifact@v4
        with:
          name: pr-analysis
          path: result.json

  comment:
    name: Comment on PR
    needs: analyze
    runs-on: ubuntu-latest
    if: always()      # so comment even if analysis fails
    on: pull_request_target
    permissions:
      pull-requests: write
    steps:
      - name: Download analysis results
        uses: actions/download-artifact@v4
        with:
          name: pr-analysis
      - name: Post comment
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ## ðŸ”Ž Automated Review Results  
            <details>
            <summary>Click to expand</summary>

            ```json
            ${{ fromJson(steps.download.outputs.content) }}
            ```
            </details>
