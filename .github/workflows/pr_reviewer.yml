- name: Generate Gemini Summary
  id: ai_summary
  env:
    GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  run: |
    python <<EOF
    import json, requests, os

    # Read Semgrep report
    try:
        with open("semgrep.json", "r") as f:
            report = f.read()
    except:
        report = "No Semgrep output found."

    prompt = f"""
    You are a code review assistant.
    Summarize the following static analysis report concisely:
    - Highlight critical issues
    - Mention files affected
    - Suggest improvements
    - Keep it under 200 words

    Report:
    {report}
    """

    url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent"
    api_key = os.getenv("GEMINI_API_KEY")

    response = requests.post(
        url + f"?key={api_key}",
        headers={"Content-Type": "application/json"},
        json={"contents": [{"parts": [{"text": prompt}]}]}
    ).json()

    # Debug print to see actual response if needed
    print("Gemini response:", response)

    # Extract safely
    summary = (
        response.get("candidates", [{}])[0]
        .get("content", {})
        .get("parts", [{}])[0]
        .get("text", "Gemini returned no summary.")
    )

    # Escape GitHub output
    summary = summary.replace("%", "%25").replace("\n", "%0A").replace("\r", "%0D")

    print(f"::set-output name=summary::{summary}")
    EOF
